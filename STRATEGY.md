# Trading Strategy

## Overview

This bot trades Polymarket's **BTC 15-minute Up/Down** binary markets using real-time **Chainlink** price data as its signal source.

**Core thesis:** If BTC has moved in one direction during a 15-minute interval, the momentum is likely to persist through resolution. The probability of persistence depends on two factors: **how much** BTC has moved and **how late** in the interval we are. Both are captured in a calibrated fair value table derived from 90 days of historical data (8,637 intervals).

The strategy is a **data-driven momentum bet with edge filtering** — it looks up a calibrated win probability for the current (move_size, elapsed_time) and only enters when that probability exceeds the market's asking price by a meaningful margin.

---

## How the Markets Work

Polymarket creates a new BTC Up/Down market every 15 minutes, aligned to UTC boundaries (e.g., 2:00, 2:15, 2:30, 2:45).

- **"Up" shares** pay $1.00 each if BTC's closing price is **>=** its opening price for the interval
- **"Down" shares** pay $1.00 each if BTC closes lower
- Before resolution, shares trade between $0.01 and $0.99 based on market-implied probability
- At resolution: winning shares snap to $1.00, losing shares snap to $0.00
- **Resolution oracle**: Chainlink Data Streams (BTC/USD), aggregated from multiple CEX sources

For example, if "Up" is trading at $0.45, the market implies a 45% chance BTC will close higher than it opened.

---

## Data Sources

| Purpose | Source | Why |
|---------|--------|-----|
| BTC price (signals) | **Chainlink via Polymarket RTDS** | Same oracle used for market resolution |
| Market discovery | **Gamma API** | Slug → token ID mapping, market metadata, outcome ordering |
| Entry pricing | **CLOB orderbook** (`get_order_book`) | Live best bid/ask, spread, depth |
| Position monitoring | **CLOB orderbook** (`get_midpoint`) | Live mid-market price for TP/SL |
| Sell pricing | **CLOB orderbook** (`get_price`) | Live best bid for immediate fills |

Notes:
- The Gamma API's `outcomePrices` field is **cached and stale** (updates every few minutes). It is NOT used for pricing — only for market discovery.
- Binance is available as a fallback feed via `PRICE_FEED=binance` env var.
- The Chainlink feed comes from Polymarket's RTDS WebSocket (`wss://ws-live-data.polymarket.com`, topic `crypto_prices_chainlink`).

---

## Signal Logic

### Calibrated Fair Value Table

The bot uses empirically calibrated fair values instead of static guesses. The table was generated by `calibrate.py` from 90 days of Coinbase BTC-USD 1-minute candle data (8,637 complete 15-minute intervals, 110,149 observations).

Each cell answers: **"When BTC has moved X% from open at Y seconds into the interval, what % of the time does it close in that direction?"**

| Move % | 60–180s | 180–420s | 420–600s | 600–840s |
|--------|---------|----------|----------|----------|
| 0.03–0.05% | 59.8% | 65.2% | 69.7% | 80.0% |
| 0.05–0.10% | 65.5% | 71.4% | 77.3% | 87.1% |
| 0.10–0.20% | 68.6% | 77.7% | 85.6% | 94.3% |
| 0.20%+ | 74.5% | 86.7% | 93.6% | 98.2% |

Key insight from calibration: **elapsed time is a stronger predictor than move size**. A small 0.03–0.05% move at 600+ seconds has a higher win rate (80%) than a large 0.10–0.20% move in the first 3 minutes (68.6%).

### TEMA Finding

Calibration also measured TEMA(10)/TEMA(80) alignment impact. Result: **TEMA provides zero predictive lift** — TEMA-aligned observations (78.7% win rate) perform identically to TEMA-opposed observations (79.0%). The move-from-open signal does all the work. TEMA was removed as an entry filter. It still runs for diagnostics/logging but does not gate entries.

### Interval Tracking

The bot aligns to 15-minute UTC boundaries and tracks BTC prices from Chainlink in real time:

- **Open price**: first price update after the interval starts
- **Latest price**: most recent price update
- **Move %**: `((latest - open) / open) * 100`
- **High/Low**: tracked for diagnostics

### Entry Window

Trades are only considered between **60 and 840 seconds** (1:00–14:00 minutes) into the interval:

- **First 60 seconds skipped**: lets the open price stabilize (aligned with calibration data)
- **Last 1 minute skipped**: avoids stale entries too close to resolution

### Signal Evaluation

On each price tick within the entry window:

1. Compute `abs_move = abs(move_pct)`
2. If `abs_move < 0.03%` → skip (below minimum threshold)
3. Look up `(abs_move, elapsed)` in the fair value table → get calibrated win rate
4. If no matching bucket → skip
5. Direction: BTC above open → "Up", below → "Down"
6. Proceed to edge calculation against live orderbook

There is no STRONG/MODERATE classification. The table encodes the relationship between move size, timing, and win probability directly.

### Outcome Validation

The bot reads the `outcomes` field from the Gamma API (e.g., `["Up", "Down"]`) and builds a lookup map to determine which `clobTokenId` index corresponds to which outcome. The ordering is never assumed.

### Edge Calculation

The bot looks up the calibrated fair value, then compares it to the **actual buy price** (what it would cost to fill):

```
fair_value = table[move_bucket][elapsed_bucket]
buy_price = min(best_ask + 0.01, 0.99)
edge = round(fair_value - buy_price, 4)
```

Edge is rounded to 4 decimal places to avoid IEEE 754 floating-point precision issues.

### Entry Filters

All of these must pass before an order is placed:

1. **Edge >= 0.02** — the calibrated fair value must exceed the buy price by at least 2 cents
2. **Buy price <= 0.95** — don't buy shares priced above 95 cents
3. **Spread <= 0.06** — skip if bid/ask spread exceeds 6 cents (liquidity too thin)
4. **Market accepting orders** — Polymarket must have the market open for trading
5. **One trade per interval** — the first accepted order locks out the rest
6. **Circuit breaker off** — session loss must be below the max threshold

### Entry Retry

If the order submission fails (API error, network issue), `trade_taken` is NOT set, allowing the bot to retry on the next evaluation cycle. Once the CLOB accepts the order, no further entries are attempted for that interval.

---

## Order Execution

- Fetches the **CLOB orderbook** to get live best bid, best ask, spread, and depth
- Places a **GTC (Good-Till-Cancelled) limit buy** at `best_ask + $0.01` (aggressive pricing to fill quickly)
- Uses `OrderArgs` with `size` in shares (not dollars) and `create_order()` + `post_order(order, OrderType.GTC)`
- Share size calculated with integer arithmetic to ensure USDC cost (`size * price`) has max 2 decimal places (API requirement)
- Default bet size: **$5 per trade**
- Minimum order value enforced at **$1** (Polymarket's floor)
- Orders are signed with `signature_type=2` (Gnosis Safe) for MetaMask proxy wallet accounts

### Fill Confirmation

After placing a GTC buy, the bot polls for fill status with a configurable timeout:

- Polls `get_order(order_id)` every 1 second for up to **20 seconds** (`ENTRY_ORDER_TIMEOUT`)
- Tracks matched quantity continuously and only treats the order as **fully filled** when `size_matched >= original_size`
- Prefers `average_matched_price` over the limit `price` when available — uses explicit None/zero checks (Python `or` chains treat `0` as falsy, masking valid values)
- If full size is matched but average price is not yet populated, does a short re-poll to let execution price propagate
- Logs raw `avg`/`match`/`limit` price fields for diagnostics
- Never infers fills from status text alone (`MATCHED` with `size_matched=0` is NOT accepted as a fill)
- If status is "CANCELED"/"EXPIRED": order didn't fill, position skipped
- **Timeout cancellation**: if not fully filled within the timeout, the bot calls `cancel(order_id)` to prevent stale orders; any partial fill is still captured and tracked

---

## Exit Logic (Auto-Sell)

After entering a position, the bot uses two exit mechanisms: a resting target sell and a time-based forced exit.

### Target Price Sell (Primary Exit)

Immediately after a buy fills, the bot places a **resting GTC SELL** at a fixed target price (default $0.95). This sits on the book and fills automatically if the share price reaches the target at any point during the interval.

- **Non-blocking placement**: The target sell is placed by the monitor loop, not inline after the buy. This avoids blocking the Chainlink price feed during on-chain settlement delays.
- **Settlement grace period**: Waits 5 seconds after buy fill before first attempt (tokens must settle on-chain).
- **Automatic retries**: If placement fails due to settlement lag ("not enough balance / allowance"), the monitor loop retries every 2 seconds indefinitely until it succeeds or the interval ends.
- **Allowance refresh**: Calls `update_balance_allowance(CONDITIONAL, token_id)` before each placement attempt.
- **Partial-fill accounting**: Resting target sells can fill in chunks; each newly matched delta is booked immediately and reduces tracked `open_shares`.

### Forced Exit (Safety Net)

If the target sell hasn't filled with **30 seconds remaining** before resolution:

1. Cancel the resting target sell (if active)
2. Re-read target order state after cancel and book any matched delta not yet accounted for
3. Place an aggressive market sell at `best_bid - $0.02` for remaining open shares only
4. This is pure damage control — if we haven't hit our target by now, get out before resolution

### Sell Mechanics

- Share size is **truncated** to 2 decimal places (`math.floor(shares * 100) / 100`) to prevent selling fractionally more than owned
- All forced sells fetch the **actual CLOB bid price** (`get_price(token_id, "SELL")`) for floor pricing
- Places an **aggressive GTC limit SELL** with a floor of `best_bid - $0.02`
- Polls `get_order()` for up to **20 seconds** (`EXIT_ORDER_TIMEOUT`) to confirm fill
- Forced sells can also be partially filled; realized proceeds/P&L are tracked incrementally and unresolved shares remain open
- **Max 3 sell attempts** — if all fail, marks position as exited to prevent spam

### Why This Strategy

- **No percentage-based TP/SL**: Old approach capped upside (TP at 25%) or exited on noise (SL at 25%). Share price swings early in an interval don't mean much — what matters is final direction.
- **Fixed target at $0.95**: Lets winners run close to their maximum value without holding into the volatile final seconds.
- **Time-based SL at 30s**: If we haven't hit $0.95 by the last 30 seconds, exit to limit damage rather than risk binary resolution.

### Resolution After Early Exit

When the interval ends:

- If **already sold** (target or forced): uses realized sell P&L and logs what would've happened if held
- If **partially sold**: carries realized P&L from sold shares, then settles only remaining `open_shares` at binary resolution
- If **fully held**: uses binary win/lose logic on full size

---

## Risk Management

### Circuit Breaker

The bot tracks cumulative session P&L. If losses exceed the threshold:

- **No new trades** are opened
- Open positions still get monitored and exited normally
- Resets on restart

Default: stop after **$15 cumulative loss** (`MAX_SESSION_LOSS`).

---

## Known Limitations

1. **Single trade per interval**: No re-entry after early exit
2. **REST polling for monitoring**: CLOB prices checked every 2s via REST, not WebSocket
3. **Target price is static**: $0.95 may not be optimal for all market conditions — may need dynamic adjustment based on entry price
4. **No per-trade stop loss**: Losers are held until forced exit at T-30s
5. **Coinbase-calibrated, not Chainlink-calibrated**: Fair value table uses Coinbase BTC-USD data as a proxy for Chainlink (resolution oracle). Basis risk is ~0.01% ($10 at $97k)
6. **Settlement lag is unpredictable**: Target sell placement depends on on-chain settlement speed, which varies

---

## Planned Improvements

See `STRATEGY_IMPROVEMENTS.md` for the full prioritized list. Key items:

- **Per-trade stop loss**: Cut losers before forced exit instead of holding until T-30s
- **Dynamic target price**: Adjust based on entry price and fair value
- **Recalibrate with Chainlink data**: Collect Chainlink ticks over time and recalibrate the table against the actual resolution oracle
- **Dynamic position sizing**: Scale bets with edge magnitude (higher edge = larger position)
- **WebSocket monitoring**: Stream CLOB orderbook updates for faster exit detection
- **Position recovery on restart**: Check for open positions and resume monitoring

---

## Configuration Reference

All parameters can be overridden via environment variables in Railway.

### General

| Parameter | Env Var | Default | Description |
|-----------|---------|---------|-------------|
| Price feed | `PRICE_FEED` | chainlink | Price source: `chainlink` (resolution-matched) or `binance` (fallback) |

### TEMA (Diagnostics Only)

TEMA is computed and logged for post-hoc analysis but **does not gate entries**. Calibration showed zero predictive lift from TEMA alignment.

| Parameter | Env Var | Default | Description |
|-----------|---------|---------|-------------|
| Candle interval | `TREND_CANDLE_INTERVAL` | 300 (5 min) | Candle size in seconds for TEMA calculation |
| TEMA fast period | `TREND_FAST_PERIOD` | 10 | Fast TEMA period (10 x 5min = 50 min lookback) |
| TEMA slow period | `TREND_SLOW_PERIOD` | 80 | Slow TEMA period (80 x 5min = 6.7 hr lookback) |

### Entry Parameters

| Parameter | Env Var | Default | Description |
|-----------|---------|---------|-------------|
| Bet size | `BET_SIZE` | $5.00 | Dollar amount per trade |
| Min move % | `MIN_MOVE_PCT` | 0.03% | Minimum BTC move to consider (table handles fair value) |
| Entry start | `ENTRY_START` | 60s | Earliest second in the interval to enter |
| Entry end | `ENTRY_END` | 840s | Latest second in the interval to enter |
| Min edge | `MIN_EDGE` | 0.02 | Minimum edge (fair - buy price) to take a trade |
| Max entry price | `MAX_ENTRY_PRICE` | 0.95 | Don't buy shares priced above this |
| Max spread | `MAX_SPREAD` | 0.06 | Skip entry if bid/ask spread exceeds this |

### Exit Parameters

| Parameter | Env Var | Default | Description |
|-----------|---------|---------|-------------|
| Target price | `EXIT_TARGET_PRICE` | 0.95 | Resting GTC sell price (primary exit) |
| Forced exit | `EXIT_BEFORE_END` | 30s | Force sell with this many seconds remaining |
| Monitor interval | `MONITOR_INTERVAL` | 2s | How often to check position and try target sell placement |
| Entry order timeout | `ENTRY_ORDER_TIMEOUT` | 20s | Seconds to wait for buy fill before cancelling |
| Exit order timeout | `EXIT_ORDER_TIMEOUT` | 20s | Seconds to wait for sell fill before cancelling |

### Risk Parameters

| Parameter | Env Var | Default | Description |
|-----------|---------|---------|-------------|
| Max session loss | `MAX_SESSION_LOSS` | $15.00 | Stop trading after this cumulative loss |
