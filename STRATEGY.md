# Trading Strategy (v5)

## Overview

This bot trades Polymarket's **BTC 15-minute Up/Down** binary markets using real-time **Chainlink** price data as its signal source.

**Core thesis:** If BTC has moved in one direction during a 15-minute interval, the momentum is likely to persist through resolution. The probability of persistence depends on two factors: **how much** BTC has moved and **how late** in the interval we are. Both are captured in a calibrated fair value table derived from 90 days of historical data (8,637 intervals).

The strategy is a **data-driven momentum bet with edge filtering** — it looks up a calibrated win probability for the current (move_size, elapsed_time) and only enters when that probability exceeds the market's asking price by a meaningful margin.

---

## How the Markets Work

Polymarket creates a new BTC Up/Down market every 15 minutes, aligned to UTC boundaries (e.g., 2:00, 2:15, 2:30, 2:45).

- **"Up" shares** pay $1.00 each if BTC's closing price is **>=** its opening price for the interval
- **"Down" shares** pay $1.00 each if BTC closes lower
- Before resolution, shares trade between $0.01 and $0.99 based on market-implied probability
- At resolution: winning shares snap to $1.00, losing shares snap to $0.00
- **Resolution oracle**: Chainlink Data Streams (BTC/USD), aggregated from multiple CEX sources

For example, if "Up" is trading at $0.45, the market implies a 45% chance BTC will close higher than it opened.

---

## Data Sources

| Purpose | Source | Why |
|---------|--------|-----|
| BTC price (signals) | **Chainlink via Polymarket RTDS** | Same oracle used for market resolution |
| Market discovery | **Gamma API** | Slug -> token ID mapping, market metadata, outcome ordering |
| Entry pricing | **CLOB orderbook** (`get_order_book`) | Live best bid/ask, spread, depth |
| Position monitoring | **CLOB orderbook** (`get_midpoint`) | Live mid-market price for TP/SL |
| Sell pricing | **CLOB orderbook** (`get_price`) | Live best bid for immediate fills |
| Historical candles | **Binance REST API** | Bootstrap data for TEMA and HTF EMA indicators |

Notes:
- The Gamma API's `outcomePrices` field is **cached and stale** (updates every few minutes). It is NOT used for pricing — only for market discovery.
- Binance is available as a fallback feed via `PRICE_FEED=binance` env var.
- The Chainlink feed comes from Polymarket's RTDS WebSocket (`wss://ws-live-data.polymarket.com`, topic `crypto_prices_chainlink`).

---

## Signal Logic

### Calibrated Fair Value Table

The bot uses empirically calibrated fair values instead of static guesses. The table was generated by `calibrate.py` from 90 days of Coinbase BTC-USD 1-minute candle data (8,637 complete 15-minute intervals, 110,149 observations).

Each cell answers: **"When BTC has moved X% from open at Y seconds into the interval, what % of the time does it close in that direction?"**

| Move % | 60-180s | 180-420s | 420-600s | 600-840s |
|--------|---------|----------|----------|----------|
| 0.03-0.05% | 59.8% | 65.2% | 69.7% | 80.0% |
| 0.05-0.10% | 65.5% | 71.4% | 77.3% | 87.1% |
| 0.10-0.20% | 68.6% | 77.7% | 85.6% | 94.3% |
| 0.20%+ | 74.5% | 86.7% | 93.6% | 98.2% |

Key insight from calibration: **elapsed time is a stronger predictor than move size**. A small 0.03-0.05% move at 600+ seconds has a higher win rate (80%) than a large 0.10-0.20% move in the first 3 minutes (68.6%).

### Interval Tracking

The bot aligns to 15-minute UTC boundaries and tracks BTC prices from Chainlink in real time:

- **Open price**: first price update after the interval starts
- **Latest price**: most recent price update
- **Move %**: `((latest - open) / open) * 100`
- **High/Low**: tracked for diagnostics

### Entry Window

Trades are only considered between **60 and 840 seconds** (1:00-14:00 minutes) into the interval:

- **First 60 seconds skipped**: lets the open price stabilize (aligned with calibration data)
- **Last 1 minute skipped**: avoids stale entries too close to resolution

### First Interval Skip

On startup, the bot skips the first (partial) interval entirely. The open price captured mid-interval is unreliable, and indicator bootstrapping may still be settling. Trading begins from the second full interval.

### Signal Evaluation

On each price tick within the entry window:

1. Compute `abs_move = abs(move_pct)`
2. If `abs_move < 0.03%` -> skip (below minimum threshold)
3. Look up `(abs_move, elapsed)` in the fair value table -> get calibrated win rate
4. If no matching bucket -> skip
5. Direction: BTC above open -> "Up", below -> "Down"
6. Check HTF EMA alignment (see below)
7. Proceed to edge calculation against live orderbook

### HTF EMA Entry Filter

An EMA(5) on 15-minute candles provides a higher-timeframe trend filter. On startup, it bootstraps from Binance historical 15-minute candles, then updates live as each 15-minute candle closes from Chainlink ticks.

- **Signal direction must align with HTF EMA direction** to proceed
- If BTC is above the EMA -> trend is Up, only "Up" entries allowed
- If BTC is below the EMA -> trend is Down, only "Down" entries allowed
- If EMA has insufficient data -> no filtering applied (pass-through)

Paper testing showed meaningful win rate improvement with this filter active.

### Outcome Validation

The bot reads the `outcomes` field from the Gamma API (e.g., `["Up", "Down"]`) and builds a lookup map to determine which `clobTokenId` index corresponds to which outcome. The ordering is never assumed.

### Edge Calculation

The bot looks up the calibrated fair value, then compares it to the **actual buy price** (what it would cost to fill):

```
fair_value = table[move_bucket][elapsed_bucket]
buy_price = min(best_ask + 0.01, 0.99)
edge = round(fair_value - buy_price, 4)
```

Edge is rounded to 4 decimal places to avoid IEEE 754 floating-point precision issues.

### Entry Filters

All of these must pass before an order is placed:

1. **Edge >= 0.02** — the calibrated fair value must exceed the buy price by at least 2 cents
2. **Buy price <= 0.89** — don't buy shares priced above 89 cents (kept below exit target so we can profit)
3. **Spread <= 0.06** — skip if bid/ask spread exceeds 6 cents (liquidity too thin)
4. **HTF EMA aligned** — signal direction must match the higher-timeframe EMA trend
5. **Not first interval** — skip the partial interval after startup
6. **Market accepting orders** — Polymarket must have the market open for trading
7. **One trade per interval** — the first accepted order locks out the rest
8. **Circuit breaker off** — session loss must be below the max threshold

### Entry Retry

If the order submission fails (API error, network issue), `trade_taken` is NOT set, allowing the bot to retry on the next evaluation cycle. Once the CLOB accepts the order, no further entries are attempted for that interval.

---

## Order Execution

- Fetches the **CLOB orderbook** to get live best bid, best ask, spread, and depth
- Places a **GTC (Good-Till-Cancelled) limit buy** at `best_ask + $0.01` (aggressive pricing to fill quickly)
- Uses `OrderArgs` with `size` in shares (not dollars) and `create_order()` + `post_order(order, OrderType.GTC)`
- Share size calculated with integer arithmetic to ensure USDC cost (`size * price`) has max 2 decimal places (API requirement)
- Default bet size: **$5 per trade**
- Minimum order value enforced at **$1** (Polymarket's floor)
- Orders are signed with `signature_type=2` (Gnosis Safe) for MetaMask proxy wallet accounts

### Fill Confirmation

After placing a GTC buy, the bot polls for fill status with a configurable timeout:

- Polls `get_order(order_id)` every 1 second for up to **20 seconds** (`ENTRY_ORDER_TIMEOUT`)
- Tracks matched quantity continuously and only treats the order as **fully filled** when `size_matched >= original_size`
- Prefers `average_matched_price` over the limit `price` when available — uses explicit None/zero checks (Python `or` chains treat `0` as falsy, masking valid values)
- If full size is matched but average price is not yet populated, does a short re-poll to let execution price propagate
- Logs raw `avg`/`match`/`limit` price fields for diagnostics
- Never infers fills from status text alone (`MATCHED` with `size_matched=0` is NOT accepted as a fill)
- If status is "CANCELED"/"EXPIRED": order didn't fill, position skipped
- **Timeout cancellation**: if not fully filled within the timeout, the bot calls `cancel(order_id)` to prevent stale orders; any partial fill is still captured and tracked

### Fee-Adjusted Share Tracking

Polymarket (or the underlying Polygon gas layer) deducts fees from the shares received, so the actual number of shares credited is slightly less than the order fill reports. For example, a fill of 8.30 shares may result in only 8.17 shares on-chain.

Before placing any sell order, the bot queries the actual conditional token balance via `get_balance_allowance()` and adjusts `open_shares` downward if the real balance is less than tracked. This prevents "not enough balance" rejections on sell orders.

---

## Exit Logic (Three Exit Paths)

After entering a position, the bot uses three exit mechanisms in priority order:

### 1. TEMA Dynamic Exit (Smart Stop Loss)

A 1-minute TEMA(5)/TEMA(12) crossover detects when the short-term trend turns against the position mid-interval. This is a "the story changed" exit — it cuts losses early when momentum reverses.

**How it works:**
- TEMA(5) and TEMA(12) are computed on 1-minute candles from Chainlink ticks, bootstrapped from Binance on startup
- On each price tick, the bot checks if the TEMA trend has *crossed* (changed direction), not just whether TEMAs are misaligned
- A cross against the position direction (e.g., TEMA turns Down while holding Up) triggers an early sell

**Safeguards:**
- **Time gate** (`EXIT_MONITOR_START = 600`): Crosses before minute 10 of the interval are ignored. Early-interval TEMA crosses are noise — the position needs time to develop.
- **Cushion filter** (`EXIT_CUSHION_PCT = 0.05`): If the trade is winning by more than 0.05% vs the interval open price when a cross occurs, the exit is skipped. The cross stays pending — if the cushion erodes below the threshold later, the exit fires. This prevents cutting winners that are comfortably ahead.

**On trigger:**
1. Cancel any resting target sell order
2. Place an aggressive market sell at `best_bid - $0.02`
3. Mark position as TEMA-exited

**Retry behavior:**
If the initial TEMA exit sell fails (rejected or unfilled), the position remains open and the monitor loop retries the sell every 2 seconds (`MONITOR_INTERVAL`) until it succeeds, the 3-attempt budget is exhausted, or the forced exit window opens. TEMA exit and forced exit have **separate** 3-attempt budgets so early failures don't block the safety net.

### 2. Target Price Sell (Profit Taking)

Immediately after a buy fills, the bot places a **resting GTC SELL** at a fixed target price (default $0.90). This sits on the book and fills automatically if the share price reaches the target.

- **Non-blocking placement**: Placed by the monitor loop, not inline after the buy, to avoid blocking the price feed during settlement.
- **Settlement grace period**: Waits 5 seconds after buy fill before first attempt (tokens must settle on-chain).
- **Automatic retries**: If placement fails due to settlement lag, the monitor loop retries every 2 seconds until it succeeds or the interval ends.
- **Allowance refresh**: Calls `update_balance_allowance(CONDITIONAL, token_id)` before each attempt.
- **Balance verification**: Queries actual token balance and adjusts sell quantity to match.
- **Partial-fill accounting**: Resting target sells can fill in chunks; each newly matched delta is booked immediately and reduces tracked `open_shares`.

### 3. Forced Exit (Safety Net)

If neither the TEMA exit nor the target sell has fully closed the position with **30 seconds remaining** before resolution:

1. Cancel the resting target sell (if active)
2. Re-read target order state after cancel and book any matched delta not yet accounted for
3. Place an aggressive market sell at `best_bid - $0.02` for remaining open shares only
4. This is pure damage control — if we haven't hit our target by now, get out before resolution

### Sell Mechanics (All Paths)

- Share size is **truncated** to 2 decimal places (`math.floor(shares * 100) / 100`) to prevent selling more than owned
- All sells fetch the **actual CLOB bid price** (`get_price(token_id, "SELL")`) for floor pricing
- Places an **aggressive GTC limit SELL** with a floor of `best_bid - $0.02`
- Polls `get_order()` for up to **20 seconds** (`EXIT_ORDER_TIMEOUT`) to confirm fill
- Sells can be partially filled; realized proceeds/P&L are tracked incrementally
- **Max 3 sell attempts** per exit path — prevents spam if orders keep failing

### Why This Strategy

- **No percentage-based TP/SL**: Old approach capped upside (TP at 25%) or exited on noise (SL at 25%). Share price swings early in an interval don't mean much — what matters is final direction.
- **TEMA catches real reversals**: Unlike a fixed stop loss, the TEMA cross responds to actual trend changes in the underlying, not share price noise.
- **Fixed target at $0.90**: Lock in gains earlier; reduces exposure to late reversals.
- **Time-based SL at 45s**: If we haven't exited by the last 45 seconds, sell to limit damage rather than risk binary resolution.

### Resolution After Early Exit

When the interval ends:

- If **already sold** (TEMA, target, or forced): uses realized sell P&L and logs what would've happened if held
- If **partially sold**: carries realized P&L from sold shares, then settles only remaining `open_shares` at binary resolution
- If **fully held**: uses binary win/lose logic on full size

---

## Risk Management

### Circuit Breaker

The bot tracks cumulative session P&L. If losses exceed the threshold:

- **No new trades** are opened
- Open positions still get monitored and exited normally
- Resets on restart

Default: stop after **$15 cumulative loss** (`MAX_SESSION_LOSS`).

---

## Known Limitations

1. **Single trade per interval**: No re-entry after early exit
2. **REST polling for monitoring**: CLOB prices checked every 2s via REST, not WebSocket
3. **Target price is static**: $0.90 (configurable) may not be optimal for all market conditions — may need dynamic adjustment based on entry price
4. **Coinbase-calibrated, not Chainlink-calibrated**: Fair value table uses Coinbase BTC-USD data as a proxy for Chainlink (resolution oracle). Basis risk is ~0.01% ($10 at $97k)
5. **Settlement lag is unpredictable**: Target sell placement depends on on-chain settlement speed, which varies
6. **Session-unaware**: No blackout for low-performance time windows (e.g., afternoon hours showed 45% win rate in paper testing)

---

## Planned Improvements

- **Session-aware filtering**: Blackout or tighten thresholds for low-performance hours (afternoon/overnight)
- **Dynamic target price**: Adjust based on entry price and fair value
- **Recalibrate with Chainlink data**: Collect Chainlink ticks over time and recalibrate the table against the actual resolution oracle
- **Dynamic position sizing**: Scale bets with edge magnitude (higher edge = larger position)
- **WebSocket monitoring**: Stream CLOB orderbook updates for faster exit detection
- **Position recovery on restart**: Check for open positions and resume monitoring

---

## Configuration Reference

All parameters can be overridden via environment variables in Railway.

### General

| Parameter | Env Var | Default | Description |
|-----------|---------|---------|-------------|
| Price feed | `PRICE_FEED` | chainlink | Price source: `chainlink` (resolution-matched) or `binance` (fallback) |

### HTF EMA (Entry Filter)

| Parameter | Env Var | Default | Description |
|-----------|---------|---------|-------------|
| EMA period | — | 5 | EMA period on 15-minute candles |
| Bootstrap | — | Binance | Historical 15-min candles fetched on startup |

### TEMA (Dynamic Exit)

| Parameter | Env Var | Default | Description |
|-----------|---------|---------|-------------|
| Candle interval | — | 60 (1 min) | Candle size in seconds for exit TEMA |
| TEMA fast period | — | 5 | Fast TEMA period |
| TEMA slow period | — | 12 | Slow TEMA period |
| Bootstrap | — | Binance | Historical 1-min candles fetched on startup |

### Entry Parameters

| Parameter | Env Var | Default | Description |
|-----------|---------|---------|-------------|
| Bet size | `BET_SIZE` | $5.00 | Dollar amount per trade |
| Min move % | `MIN_MOVE_PCT` | 0.03% | Minimum BTC move to consider (table handles fair value) |
| Entry start | `ENTRY_START` | 60s | Earliest second in the interval to enter |
| Entry end | `ENTRY_END` | 840s | Latest second in the interval to enter |
| Min edge | `MIN_EDGE` | 0.02 | Minimum edge (fair - buy price) to take a trade |
| Max entry price | `MAX_ENTRY_PRICE` | 0.89 | Don't buy above this (must be below exit target) |
| Max spread | `MAX_SPREAD` | 0.06 | Skip entry if bid/ask spread exceeds this |

### Exit Parameters

| Parameter | Env Var | Default | Description |
|-----------|---------|---------|-------------|
| Target price | `EXIT_TARGET_PRICE` | 0.90 | Resting GTC sell price (profit taking) |
| Forced exit | `EXIT_BEFORE_END` | 45s | Force sell with this many seconds remaining |
| Monitor interval | `MONITOR_INTERVAL` | 2s | How often to check position and try target sell placement |
| TEMA exit start | `EXIT_MONITOR_START` | 600s | Seconds into interval before TEMA exit becomes active |
| TEMA cushion | `EXIT_CUSHION_PCT` | 0.05% | Skip TEMA exit if winning by more than this vs open |
| Entry order timeout | `ENTRY_ORDER_TIMEOUT` | 20s | Seconds to wait for buy fill before cancelling |
| Exit order timeout | `EXIT_ORDER_TIMEOUT` | 20s | Seconds to wait for sell fill before cancelling |

### Risk Parameters

| Parameter | Env Var | Default | Description |
|-----------|---------|---------|-------------|
| Max session loss | `MAX_SESSION_LOSS` | $15.00 | Stop trading after this cumulative loss |
